# STRIDE для Study Plan App (покрытие и контроль)

## Легенда
- **S**poofing (подмена личности) · **T**ampering (подмена данных) · **R**epudiation (отрицание действий) · **I**nfo Disclosure (разглашение) · **D**oS (отказ) · **E**oP (повышение привилегий)

---

## Таблица угроз (узел/поток → угроза → STRIDE → контроль/NFR → проверка)

| Узел / Поток | Угроза (сценарий) | STRIDE | Контроль / Мера | NFR | Проверка / Доказательство | Статус |
|---|---|---|---|---|---|---|
| Клиент → Ingress → FastAPI (`POST /topics`) | Повторная отправка (replay) создаёт дубликаты | T/D | Идемпотентность через заголовок `Idempotency-Key` или дедупликация по (`title`,`deadline`) | NFR-08 | pytest: тест на повтор `POST` → одна запись | **План** |
| Клиент → Ingress → FastAPI (все маршруты) | Подмена источника трафика (без TLS можно MITM) | S/T/I | TLS на уровне ingress + HSTS + только HTTPS | **NFR-09 (предложение)** | curl/httpx проверки, SSL отчёт, интеграционные тесты | **План** |
| Ingress CORS → FastAPI | Браузерный доступ с любого Origin (XSS-встраивание клиента) | I/E | Жёсткий CORS-allowlist (только доверенные Origins) | **NFR-10 (предложение)** | Автотест CORS (preflight 403 для лишних Origins) | **План** |
| `POST /topics` тело запроса | Подмена/некорректные данные (`progress`, `title`) | T | Pydantic-валидация: `title` обязателен, `progress ∈ [0;100]` | NFR-03 | pytest: `test_validation_error` | **Есть** |
| `PUT /topics/{id}/progress` | Подмена значения прогресса вне доменных границ | T | Уже покрыто `ProgressUpdate(progress: 0..100)` | NFR-03 | pytest: граничные значения | **Есть** |
| `GET /topics` / `GET /topics/{id}` | Утечка лишних полей/трассировок ошибок | I | Единый формат ошибок (без stacktrace), whitelisting полей в схемах | NFR-02 | pytest: проверка тела 404/422; негативные тесты | **Частично** |
| Обработка ошибок FastAPI | Непоследовательный формат 404/422 → информационное раскрытие | I/R | Глобальный exception-handler, маскирование внутренних деталей | NFR-02 | pytest: snapshot тела ошибок | **План** |
| Логирование middleware | Отрицание действий (нет аудита) | R | Логи всех запросов `/topics` (уже есть), добавить корреляционный `X-Request-ID` | NFR-05 | pytest с `caplog`, наличие `X-Request-ID` | **Частично** |
| API → SQLAlchemy ORM | SQL-инъекция / raw SQL | T/E | Только ORM-запросы (запрет `.execute()`), статический анализ | NFR-04 | Semgrep/Bandit правило на raw-SQL; code review | **План** |
| БД (SQLite) | Неконсистентность после удаления (фантомные чтения) | T | Транзакционность CRUD и тесты на «после удаления не получить» | NFR-08 | pytest CRUD: delete→404 | **Есть** |
| Производительность API | Перегрузка без rate-limit → деградация, ошибки | D | Rate-limit/токены на ingress; k6/Locust профили | NFR-06, NFR-01 | Отчёт k6: p95, error_rate≤2% | **План** |
| Тела запросов | Большие payload → раздувание памяти | D | Ограничение размера тела (Body Size Limit middleware) | NFR-06 | Интеграционный тест: >N байт → 413 | **План** |
| Идентификаторы ресурсов (`/topics/{id}`) | Перебор ID (IDOR) при появлении auth | E/I | Object-level auth на уровне слоя доступа | **NFR-11 (отложено)** | Тесты доступа (role-based) | **N/A сейчас** |
| Роли и права | Повышение привилегий (нет разграничения) | E | RBAC/ABAC при вводе пользователей | **NFR-11 (отложено)** | AuthZ тесты | **N/A сейчас** |

> Примечания:
> • **Предложенные NFR**: NFR-09 «Периметр (TLS/HSTS)», NFR-10 «CORS-политика», NFR-11 «Аутентификация/Авторизация». Их можно добавить в P03, чтобы формально связать меры.
> • Где отмечено «Частично» — базовая мера уже есть (валидация/логирование), но требуется усиление (формат ошибок, `X-Request-ID`).

---

## Ключевые узлы/потоки (9 штук)

1) Внешний периметр: TLS/HSTS
2) CORS-политика ingress
3) `POST /topics`
4) `GET /topics`
5) `GET /topics/{id}`
6) `PUT /topics/{id}/progress`
7) `DELETE /topics/{id}`
8) Логирование и обработка ошибок
9) ORM-слой и БД

На каждый узел помечено 1–2 угрозы; всего покрыто **14 угроз** (≥12).

---

## Исключения (не применимо) с обоснованием

- **CSRF**: не применимо сейчас — нет cookie-сессий/браузерной аутентификации; взаимодействие ожидается по bearer/ключам → оценим при вводе auth.
- **IDOR/Role-based EoP**: в MVP нет пользователей и ролей — угрозы отмечены как **N/A**, но добавлены как обязательные к внедрению при появлении аутентификации (NFR-11).
- **Подпись/целостность на уровне сообщения**: для JSON-API поверх TLS обычно избыточна; повторно оценим при интеграциях B2B.

---

## План внедрения (минимальный чек-лист к ★★)

1) **Периметр**: включить TLS и HSTS на ingress; добавить `X-Content-Type-Options: nosniff`, `Referrer-Policy: no-referrer` (**NFR-09**).
2) **CORS**: строгий allowlist Origins; запрет credentials; preflight-проверки (**NFR-10**).
3) **Ошибки**: глобальный handler → единый JSON без трассировок (**NFR-02**).
4) **Логи/аудит**: `X-Request-ID` в запрос/ответ; логировать метод/путь/код/время (**NFR-05**).
5) **DoS**: rate-limit на ingress; лимит размера тела; k6-профили по RPS (**NFR-06**, **NFR-01**).
6) **Дубликаты**: `Idempotency-Key` для `POST /topics` или бизнес-дедупликация (**NFR-08**).
7) **ORM-гигиена**: правило Semgrep на запрет raw SQL; PR-гайд (**NFR-04**).
8) **Тесты**: дополнить pytest наборами для валидаторов/ошибок/CRUD/idempotency; довести coverage ≥80% (**NFR-07**).

---

## Доказательства (ссылки на артефакты)

- **Код**: `app/main.py`, `app/schemas/topic.py`, `app/models/topic.py`, `app/database.py` — есть CRUD, Pydantic-валидация (NFR-03), базовое логирование (NFR-05).
- **Тесты**: `tests/` — добавить/актуализировать `test_validation_error`, `test_not_found_topic`, CRUD-набор, негативные сценарии CORS/большие тела (NFR-02/03/07/08).
- **Нагрузка**: профиль k6/Locust с отчётом p95 и error_rate (NFR-01/06).
- **Статика**: конфиг Semgrep/Bandit на raw SQL (NFR-04).
- **Ops**: конфиг ingress с TLS/HSTS и CORS (NFR-09/10).

---

### Краткое резюме покрытия
- Узлы/потоки: **9** (в пределах 5–10).
- Размеченных угроз: **14** (≥12).
- Исключения с обоснованием: есть (CSRF, IDOR/RBAC, подпись сообщений).
→ Требования **★★** выполняются при внедрении мер из чек-листа и фиксации артефактов в репозитории.
